---
title: "SVG Detection"
author: "Daniel Israel Kakou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(STANCE) # for benchmark data mOB
```


# Detecting SVGs

Suppose that we have spatial transcriptomics expression data for $q$ genes at $n$ spots (or pixels) in a two-dimensional tissue. The spatial coordinates of the $i$th spot are denoted by

$$
\mathbf{s}_i = (s_{i1}, s_{i2})^{\top}, \quad i = 1, \ldots, n,
$$

where the superscript $\top$ denotes vector transpose and $\mathbf{s}_i$ is a $2 \times 1$ vector.

For a particular gene, let $y_i$ denote the gene expression value at the $i$th spot. The values $y_i$ are allowed to be sparse raw counts, a well-known phenomenon in spatial transcriptomics data. Let $\mu_i = \mathbb{E}(y_i)$ denote the spot-specific mean expression. When the gene is not spatially variable, these spot-specific means share a common value $\mu$. Hence, the null hypothesis of interest is

$$
H_0: \mu_1 = \mu_2 = \cdots = \mu_n = \mu.
$$ {#eq-null}

If this null hypothesis is rejected, then the gene is said to be spatially variable.

Let

$$
\delta_{ij} = y_i - y_j
$$

and let $d_{ij}$ denote the Euclidean distance between spots $i$ and $j$, defined as

$$
d_{ij} = \sqrt{(s_{i1} - s_{j1})^2 + (s_{i2} - s_{j2})^2}.
$$

The quantities $\delta_{ij}^2$ and $d_{ij}^2$ measure the dissimilarity in gene expression and the dissimilarity in spatial location, respectively, between spots $i$ and $j$.

Our proposed test statistic for testing the null hypothesis in @eq-null is

$$
T = \sum_{i < j} \delta_{ij}^2 d_{ij}^2
  = \langle \boldsymbol{\delta}^2, \mathbf{d}^2 \rangle,
$$ {#eq-teststat}

where $\boldsymbol{\delta}^2 = \mathrm{vec}(\delta_{ij}^2)$ and $\mathbf{d}^2 = \mathrm{vec}(d_{ij}^2)$. Both $\boldsymbol{\delta}^2$ and $\mathbf{d}^2$ are vectors of length $n(n - 1)/2$.

Under the null hypothesis @eq-null, the expression counts $y_i$ are independently and identically distributed, irrespective of the spatial locations of the spots. To ensure that the proposed method remains fully nonparametric, the $p$-value for the test statistic $T$ is obtained via a permutation procedure.


```{r}

# Helper Function to compute statistic
compute_T <- function(y, D2) {
  # y: length n vector from gene expression
  # D2: n x n matrix of squared distances from spatial location
  
  y_diff2 <- outer(y, y, "-")^2
  T <- sum(y_diff2 * D2)
  return(T)
}

# Function to test for a svg
perm_test_one_gene <- function(y, D2, B = 500, seed = NULL) {
  
  if (!is.null(seed)) set.seed(seed)

  T_obs <- compute_T(y, D2)
  n <- length(y)

  # permuted T's
  T_perm <- replicate(B, {
    y_perm <- sample(y, n, replace = FALSE)
    compute_T(y_perm, D2)
  })

  
    # -------------------------------
  # permutation p-value
  # -------------------------------
  
  # mean deviation
  mu_perm <- mean(T_perm)
  p_value <- (1 + sum(abs(T_perm-mu_perm) >= abs(T_obs - mu_perm)))/ (B + 1)
  
  

  list(
    T_obs = T_obs,
    T_perm = T_perm,
    p_value=  p_value
  )
}


```


# Example
Testing if a gene "Nrgn" from mOB is svg.

```{r pressure, echo=FALSE}
data(mOB)
Y = mOB$counts
S = mOB$pos
D2  <- as.matrix(dist(S))

system.time(
  result <- perm_test_one_gene(
  y = Y["Nrgn", ],
  D2 = D2,
  B = 500, seed = 123))

```

```{r}
result$T_obs
result$p_value
hist(result$T_perm, breaks = 30,
     main = "Permutation null for T stat",
     xlab = "T stat")
abline(v = result$T_obs, col = "red", lwd = 2)
```


## Alternative method

```{r}

# Helper Functions
quad_form_cor <- function(w, z, pair_struct) {
  i   <- pair_struct$i
  j   <- pair_struct$j
  rho <- pair_struct$rho

  wz <- w * z
  sum_wz <- sum(wz)

  spots   <- c(i, j)
  w_long  <- rep(w, 2)
  z_long  <- rep(z, 2)
  wz_long <- rep(wz, 2)

  Sw  <- rowsum(w_long,  spots)
  Sz  <- rowsum(z_long,  spots)
  Swz <- rowsum(wz_long, spots)

  C <- sum(Sw * Sz) - sum(Swz)

  as.numeric(sum_wz + rho * C)
}

build_pair_structure <- function(S, rho = 0.25, scale_d2 = FALSE) {
  S <- as.matrix(S)
  n <- nrow(S)
  stopifnot(ncol(S) == 2)

  pairs <- utils::combn(n, 2)
  i <- pairs[1, ]
  j <- pairs[2, ]
  m <- ncol(pairs)

  d2 <- rowSums((S[i, , drop = FALSE] - S[j, , drop = FALSE])^2)

  # optional scaling to prevent numerical explosion (keeps sign positive)
  if (scale_d2) d2 <- d2 / max(d2)

  ps <- list(i = i, j = j, d2 = d2, m = m, n = n, rho = rho)
  ps$denom_d2 <- quad_form_cor(d2, d2, ps)
  ps
}
```


```{r}
gee_svg_one_gene_perm <- function(
  y,
  pair_struct,
  B = 500,
  seed = NULL
) {
  if (!is.null(seed)) set.seed(seed)

  i <- pair_struct$i
  j <- pair_struct$j
  d2 <- pair_struct$d2
  n  <- pair_struct$n

  stopifnot(length(y) == n)

  # -------------------------------
  # Observed beta
  # -------------------------------
  delta2_obs <- (y[i] - y[j])^2
  delta2_obs_centered <- delta2_obs - mean(delta2_obs)
  num_obs <- quad_form_cor(d2, delta2_obs_centered, pair_struct)
  beta_obs <- num_obs / pair_struct$denom_d2

  # -------------------------------
  # Permutation null
  # -------------------------------
  beta_perm <- numeric(B)

  for (b in seq_len(B)) {
    idx <- sample(n, n, replace = FALSE)
    yp  <- y[idx]

    delta2_p <- (yp[i] - yp[j])^2
    delta2_p_centered <- delta2_p - mean(delta2_p)
    num_p <- quad_form_cor(d2, delta2_p_centered, pair_struct)
    beta_perm[b] <- num_p / pair_struct$denom_d2
  }

  # -------------------------------
  # permutation p-value
  # -------------------------------
  
  # mean deviation
  mu_perm <- mean(beta_perm)
  p_value <- (1 + sum(abs(beta_perm-mu_perm) >= abs(beta_obs - mu_perm)))/ (B + 1)
  

  list(
    beta_obs  = beta_obs,
    beta_perm = beta_perm,
    p_value    = p_value
  )
}

```



```{r}
pair_struct <- build_pair_structure(S, rho = 0.25, scale_d2 = TRUE)   # should be very quick now

system.time(
  result2 <- gee_svg_one_gene_perm(
  y = Y["Nrgn", ],
  pair_struct = pair_struct,
  B = 500,
  seed = 123
))

```


```{r}
result2$beta_obs
result2$p_value
hist(result2$beta_perm, breaks = 30,
     main = "Permutation null for T stat",
     xlab = "T stat")
abline(v = result2$beta_obs, col = "red", lwd = 2)

```

